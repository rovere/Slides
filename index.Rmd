---
title       : DQM GUI Ideas
subtitle    : Possible extension to make DQM GUI a  distributed service
author      : M. Rovere, PH-CMG-CO, CERN
job         : CERN
framework   : io2012        # {io2012, html5slides, shower, dzslides, ...}
highlighter : prettify      # {highlight.js, prettify, highlight}
hitheme     : twitter-bootstrap # sunburst      #
widgets     : [mathjax]            # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone,draft}

--- .segue .dark .nobackground

## Motivation

---

## Many Requirements, One application

### <font class='red bold'>Offline</font> Requirements

1. Quickly digest all data coming in from Tier-0
1. Handle a huge volume of data (~2.5TB)
1. Handle a huge number of samples
1. Quickly digest all data coming from reprocessing

### <font class='red bold'>RelVal</font> Requirements

1. Handle a huge number of histograms
1. Quickly digest Relval samples injected by WMAgent
1. Moderate data volume (~1TB)

### <font class='red bold'>Online</font> Requirements

1. Live feedback from Online DQM Apps
1. Small number of samples
a. Small disk size

---

## How to satisfy requirements

### <font class='red bold'>Offline</font>

1. Buy performant/expensive dedicated hardware
1. Design a fast application

### <font class='red bold'>RelVal</font>

1. Buy performant/expensive dedicated hardware
1. Design a fast application

### <font class='red bold'>Online</font>

1. Design a fast application
1. Use dedicated/fast network protocol to transmit histograms in live mode.

---

## Scaling ...

- While buy new hardware is a legittimate step, it is clear that it
is not going to scale in the longish term
   - computing is going in the opposite direction:
       - multi-threading and parallelisation
       - <font class='red bold'>horizontal scaling</font>

- DQM GUI is no exception in this respect

- CERN IT is less and less willing to buy, configure and handle dedicated hardware

- vocms138 and vocms139 are already <font class='red bold'>out of
  warranty</font> and will soon be retired

- <font class='blue bold'>Need to find adeguate replacements, trying
  to satisfy all needs, keeping the highest possible performances,
  possibly improving the system</font>

- In this process, I started to think what DQM GUI could be in the
  (maybe not so near) future.

---

## Switch to Virtual Machines

Moving the current produciton servers to Virtual Machines is not an immediate step.

- Current production servers have hardware RAID 6 to cope with
single(multiple) disk failures.

- The current read/write on disk capabilities are ~700/~350 MB/s, not
reproducible using a VM with an ordinary disk attached.

- Few solutions have been explored during a dedicated meeting with IT guys.
   - I will put together an ad-hoc test suite to measure reasonable performances of the current servers
   - Compare these numbers with the proposed solutions
   - Try to come up with some reasonable requirements from CMS
       - As fast as possible is not a <font class='red bold'>good</font> metric. 

- Good occasion to re-think a bit the DQM GUI applications and give a
  thought about what could be done to cope with less performant
  operating hardware

---

## A few important remarks

- <font class="blue2">Good software does not happen by magic ...</font>
- The DQM GUI is the work mainly of <font class="red">Lassi Tuura</font> and <font class="red">Giulio Eulisse</font>
    - all glory should go to them.
- Since 2010 I have been taking care of it.
- There are many topics involved in the DQM GUI:
    - its backend design (<font class="blue3">index</font>)
    - its web server (<font class="blue3">CherryPy</font>)
    - its Javascript Frontend (<font class="blue3">YUI+ExtJS</font>)
- It is not possible to focus on all of them w/in few hours, a selection is made here.
- <font class="red2">This is not a tutorial on GUI's capabilities</font>
- be patient w/ slides: it's my first attempt at using HTML5 + GoogleIO + MarkDown.

---

## Agenda

### Things we'll cover today:

- General DQM GUI design principles
- Overview of the current backend

--- .segue .dark .nobackground

## General Overview: main design aspects

---

## DQM GUI in few words

- Web based interface to browse histograms stored in a ROOT file.
- Focus on robustness and speed. 
- Based on CherryPy, Javascript (YUI, ExtJS) and C++ code on [github](http://github.com/rovere/dqmgui)
- Understands <font class="blue2">TH{1,2,3}{S,I,F,D}, TProfile{,2D},
strings, ints, floats.</font>
- Histograms extracted directly from <font class="blue2">plain ROOT files.</font>
- ROOT files/histograms ofter/always available for download.
- Scales up to O(10TB) objects indexed, O(+Million) unique Monitor Element names.

--- &singleimage w1:50 image:images/DQM_GUI_servers.png

## DQM GUI Architecture

---

## DQM GUI in numbers

- O(15K) lines of C++ code (web server accelerator, render engine, index manipulation) 
- O(5K) python lines
- O(4K) javascript lines.

<article class="smaller">
<table>
 <tr>
  <th>Quantity</th><th>Offline Server</th><th>RelVal Server</th><th>Online Server</th>
 </tr>
  <td>SAMPLES</td><td>264.383</td><td>31.587</td><td>16.042</td>
</tr>
<tr>
    <td>SOURCE FILES</td><td>303.580</td><td>31.744</td><td>387.298</td>
</tr>
<tr>
    <td>DATASETS</td><td>2.068</td><td>18.379</td><td>1</td>
</tr>
<tr>
    <td>UNIQUE OBJS</td><td>913.174</td><td>1.649.086</td><td>346.448</td>
</tr>
<tr>
    <td>STREAMERS</td><td>1</td><td>1</td><td>2</td>
</tr>
<tr>
    <td>DISK SIZE(TB)</td><td>2.5</td><td>0.38</td><td>0.06</td>
</tr>
</table>
</article>

--- .segue .dark .nobackground

## DQM GUI basic concepts

---

## How a page is created

- All pages are dynamically created starting from
    - templated html
    - information retrieved from the server
    - Javascript plugins
    - stateful HTML via unique URL redirection and server side python dictionary: [cmsweb/dqm/offline](https://cmsweb.cern.ch/dqm/offline)
    - all interaction w/ GUI are:
        - send AJAX request
        - update server-side <font class="blue2">state</font>
        - receive <font class="blue2">state</font> object and render it

---

## The state object

<article class="smaller">
<pre class="prettyprint" data-lang="json">
([
  {<b>'kind':'AutoUpdate'</b>, 
   'interval':300, 
   'stamp':1398331290.056085, 
   'serverTime':97.564000
  },
  {<b>'kind':'DQMHeaderRow'</b>, 'run':"221'242", 'lumi':"2'458",
   'event':"97'324'253", 'runstart':"Sun Apr 13, 06:11",
   'service':'Offline', ...
  },
  {<b>'kind':'DQMQuality'</b>, 
   'items':[{'label':"CSC",
             'version':1397610899608040000,
             'name':"CSC/EventInfo/reportSummaryMap",
             'location':"archive/221242/MinimumBias/Commissioning201-PromptReco-v1/DQM",
             'reportSummary':"1",
             'eventTimeStamp':""
            }, ...
          ]
  }])
</pre>
</article>

---

## DQMQuality plugin example

<article class="smaller">
<pre class="prettyprint" data-lang="javascript">
GUI.Plugin.DQMQuality = new function()
{
  ...
  this.attach = function(gui) { _gui = gui; };
  this.detach = function() { ... };
  /** Update this plug-in display.  Fills the canvas area with a floating image panel for each DQM source
      for which we have the required summary information and 2D map.  Updates the page incrementally to 
      avoid flashing. */
  this.update = function(data) { 
    _items = data.items;
    var status = data.items;
    ...
    // If there is no contents to show, display a simple message.
    if (! status.length) {
      var content = " < div ...>< p >
      No data are presently available or the DQM producers have not generated the standard EventInfo summary information.< /p >< /div >";
      if (_canvas.innerHTML != content) _canvas.innerHTML = content;
    } ... }
  ...
}();
</pre>
</article>

<footnote class="source">[source](https://github.com/rovere/dqmgui/blob/index128/src/javascript/DQM/Quality.js)</footnote>

--- .segue .dark .nobackground

## DQM GUI Backend: main design aspects

---

## Main concepts

- The backend does not use any open source nor commercial database.
- it is not exactly a database, even if it uses <font class="blue2">keys</font> to index and retrieve data
- entirely written in C++
    - multiple-readers, single-writer
    - extremely optimised for our use case
    - not a general purpose backend
- The index is a directory containing one well-known generation ID identifying current <font class="blue2">master catalogue</font> which in turn references the <font class="blue2">data files with the actual data content</font>.

--- &singleimage w1:100 image:images/index_file_layout.png

## Typical file's layout


--- &singleimage w1:100 image:images/index_keys.png

## Keys, keys and more keys...


--- &singleimage w1:60 image:images/Lassi.png

## p-trie

--- &singleimage w1:70 image:images/Tuura.png

## p-trie, p-tries


--- &singleimage w1:75 image:images/thought.png

## p-trie, p-tries and more p-tries

--- &singleimage w1:80 image:images/and.png

## p-trie, p-tries and more p-tries

--- &singleimage w1:80 image:images/developed.png

## p-trie, p-tries and more p-tries

--- &singleimage w1:80 image:images/it.png

## p-trie, p-tries and more p-tries

--- 

## Pages, pages and more pages

A typical (un)-compressed, generic datapage in memory is laid out as in the following figure:
<article class="flexbox vcenter">
<img src="images/datapage.png" alt="In-memory datapage" title="In-memory datapage" width="100%">
</article>

When persisted on disk, the layout is optimised and compressed even more, as follows:
<article class="flexbox vcenter">
<img src="images/datapage_ondisk.png" alt="On-disk datapage" title="On-disk datapage" width="100%">
</article>

---

## The master catalogue

- The <font class="blue2">master catalogue</font> identifies data samples by a (dataset; runnr or cmssw version) tuple. 
- The master catalogue contains the following information.
    - Key <font class="blue2">MASTER_SAMPLE_RECORD</font>
    - Key <font class="blue2">MASTER_SOURCE_PATHNAME</font>
    - Key <font class="blue2">MASTER_DATASET_NAME</font>
    - Key <font class="blue2">MASTER_CMSSW_VERSION</font>
    - Key <font class="blue2">MASTER_OBJECT_NAME</font>
    - Key <font class="blue2">MASTER_TSTREAMERINFO</font>
- <font class="red2">All this info is in-memory on the server for ultra-fast access.</font>
<article class="smaller">
<pre class="prettyprint" data-lang="c++">
static const uint64_t MASTER_SAMPLE_RECORD       = ((uint64_t) 0) << 32;
static const uint64_t MASTER_SOURCE_PATHNAME     = ((uint64_t) 1) << 32;
static const uint64_t MASTER_DATASET_NAME        = ((uint64_t) 2) << 32;
static const uint64_t MASTER_CMSSW_VERSION       = ((uint64_t) 3) << 32;
static const uint64_t MASTER_OBJECT_NAME         = ((uint64_t) 4) << 32;
static const uint64_t MASTER_TSTREAMERINFO       = ((uint64_t) 5) << 32;
</pre>
</article>

---

## Sample

<article class="smaller">
<pre class="prettyprint" data-lang="c++">
struct Sample
{
 uint64_t firstImportTime;
 uint64_t lastImportTime;
 uint32_t importVersion;<b>
 uint32_t files[2];
 uint32_t sourceFileIdx;
 uint32_t datasetNameIdx;
 uint32_t streamerInfoIdx;
 uint32_t cmsswVersion;</b>
 int32_t  runNumber;
 uint32_t numObjects;
 uint64_t numLumiSections;
 uint64_t runStartTime;
 uint64_t processedTime;
};
</pre>
</article>

---

## Info and Data files

- In addition to the master catalogue, the index contains <font class="blue2">two other types of files</font>: 
    - summary and statistics
    - object data. 
- Each type is in separate files, built up to about 500MB per file
- Inside the data files objects are ordered by 64-bit keys
    - top 20 bits are the sample index
    - 4-bit type identifier
    - 20-bit lumi section index
    - 20-bit object name index. 

---

## Info and Data files

- The <font class="blue2">sample index</font> is the index of this sample in the master catalogue.  
- The <font class="blue2">object name index</font> is the monitor element name in the master catalogue table of names.
- The <font class="blue2">object data file</font> contains two serialised ROOT objects per key: the object itself and the reference
- To extract the objects first read in and activate the [streamer info](https://github.com/rovere/dqmgui/blob/index128/src/cpp/DQM/VisDQMTools.h#L149) for the sample in the master catalogue, then simply extract objects from the byte buffer as long as it has data left in it. 
- No ROOT object is stored for the scalar monitor elements. 

---

## image URL explained


- How to locate a single histogram that fast?

http://.../dqm/offline/<font class="blue2">plotfairy/</font><font class="red2">archive</font>/196531/<font class="green2">JetHT/Run2012B-PromptReco-v1/DQM</font>/<font class="yellow">Tracking/TrackParameters/GeneralProperties/NumberOfTracks_GenTk</font>...

- <font class="blue2">API specification</font>
- <font class="red2">Source specification</font>
- <font class="green2">Dataset specification</font>
- <font class="yellow2">Object Specification</font>

---

## image URL explained

### Overall search logic

1. Locate p-trie index for the specified <font class="green2">Dataset</font> (ultra-fast in-memory + p-trie)
1. Locate sample that corresponds to tuple (dataset, run)
1. create full <font class="blue2">64-bits key</font> for objects requested
1. Open <font class="blue2">data-file</font> linked to the proper sample
1. <font class="blue2">Read its index and immediately jump to the correct page</font>
1. Un-compress the page and <font class="blue2">look for the exact key, grab proper serialized ROOT object</font>
1. <font class="blue2">Deserialise it using proper Streamer (index grabbed from the sample)</font>
1. pass decoded ROOT object to rendering engine
1. Typical time ~ 100ms. (<< if in cache...)

--- .segue .dark .nobackground

## DQM GUI Performances

---

## DQM GUI Performances

<article class="flexbox vcenter">
<img src="images/OfflineAccesses2011_2012.png" alt="Offline Accesses" title="Offline Accesses" width="100%">

<img src="images/OfflineResponseTime2011_2012.png" alt="Offline Response Time" title="Offline Response Time" width="100%">
</article>

--- .segue .dark .nobackground

## Further Readings

---

## Links

- [Code in github](http://github.com/rovere/dqmgui)
- [M.Rovere@ROOT Users Workshop 2013 - Saas Fee](https://indico.cern.ch/event/217511/contribution/42/material/slides/0.pdf)
- [M.Rovere@LHCb Computing Workshop CERN, 23 May 2013](https://indico.cern.ch/event/236650/session/5/contribution/51/material/slides/0.pdf)
- [L Tuura et al 2010 J. Phys.: Conf. Ser. 219 072055](http://iopscience.iop.org/1742-6596/219/7/072055/pdf/1742-6596_219_7_072055.pdf)
- [P-Trie](http://en.wikipedia.org/wiki/Radix_tree)
- [CherryPy](http://www.cherrypy.org/)
- [Sencha - ExtJS](http://www.sencha.com/products/extjs/)
- [YUI](http://yuilibrary.com/)


