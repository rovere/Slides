---
title       : DQM GUI Ideas
subtitle    : Possible extension to make DQM GUI a  distributed service
author      : M. Rovere, PH-CMG-CO, CERN
job         : CERN
framework   : io2012        # {io2012, html5slides, shower, dzslides, ...}
highlighter : prettify      # {highlight.js, prettify, highlight}
hitheme     : twitter-bootstrap # sunburst      #
widgets     : [mathjax]            # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone,draft}

--- .segue .dark .nobackground

## Motivation

---

## Many Requirements, One application

### <font class='red bold'>Offline</font> Requirements

1. Quickly digest all data coming in from Tier-0
1. Handle a huge volume of data (~2.5TB)
1. Handle a huge number of samples
1. Quickly digest all data coming from reprocessing

### <font class='red bold'>RelVal</font> Requirements

1. Handle a huge number of histograms
1. Quickly digest Relval samples injected by WMAgent
1. Moderate data volume (~1TB)

### <font class='red bold'>Online</font> Requirements

1. Live feedback from Online DQM Apps
1. Small number of samples
a. Small disk size

<font class='red bold'>These requirements will be extended to even
higher values in Run2 and Phase1&2 upgrades</font>

---

## How to satisfy requirements

### <font class='red bold'>Offline</font>

1. Buy performant/expensive dedicated hardware
1. Design a fast application

### <font class='red bold'>RelVal</font>

1. Buy performant/expensive dedicated hardware
1. Design a fast application

### <font class='red bold'>Online</font>

1. Design a fast application
1. Use dedicated/fast network protocol to transmit histograms in live mode.

---

## Scaling

### General considerations

- While buying new hardware is a legittimate step, it is clear that it
is not going to scale in the longish term
   - computing is going in the opposite direction:
       - multi-threading and parallelisation
       - <font class='red bold'>horizontal scaling</font>

- DQM GUI is no exception in this respect

- CERN IT is less and less willing to buy, configure and handle dedicated hardware

- vocms138 and vocms139 are already <font class='red bold'>out of
  warranty</font> and will soon be retired

- <font class='blue bold'>Need to find adeguate replacements, trying
  to satisfy all needs, keeping the highest possible performances,
  possibly improving the system</font>

- In this process, I started to think what DQM GUI could be in the
  (maybe not so near) future.

---

## Scaling

### Viable Approaches

- Invest in hardware (vertical scaling)
- Invest in software (horizontal scaling)
   - Swap the current backend with a viable distributed backend
   - Modify the current backend to be a distributed backend




|                                        | Hardware                                                                                                     | Software/Open Source distributed backend                                                                                | Software/Make current backend distributed                       |
|----------------------------------------|--------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------- |
| <font class='red bold'>CONS</font>     | Expensive                                                                                                    | Big evaluation time                                                     					          | Non-negligible development effort                               |
|                                        | Not the preferred solution from IT                                                                           | Development integration time                                                                                            |                                                                 |
|                                        | Additional load on us, since they would outsource the  configuration/handling/alarming of commodity hardware | steep learning curve (see, e.g., ongoing effort for Conditions in CMSSW)                                                |                                                                 |
| <font class='green bold'>PROS</font>   | No software development                                                                                      | Solid rock/tested/community supported software                                                                          | Start from a solid-rock code                                    |
|                                        |                                                                                                              |                                                                                                                         | Affordable learning curve                                       |
| <font class='blue bold'>REMARKS</font> |                                                                                                              | <font class='yellow3 bold'>PREFERRED CHOICE FOR LONG TERM</font> (technical student?)                                   | <font class='green bold'>PREFERRED CHOICE FOR SHORT TERM</font> |

---

## Switch to Virtual Machines

### Current situation/proposal

Moving the current produciton servers to Virtual Machines is not an immediate step.

- Current production servers have hardware RAID 6 to cope with
single(multiple) disk failures.

- The current read/write on disk capabilities are ~700/~350 MB/s(read/write), not
reproducible using a VM with an ordinary disk attached.

- Few solutions have been explored during a dedicated meeting with IT guys.
   - I will put together an ad-hoc test suite to measure reasonable performances of the current servers
   - Compare these numbers with the proposed solutions
   - Try to come up with some reasonable requirements from CMS
       - As fast as possible is not a <font class='red bold'>good</font> metric. 

- <font class='yellow bold'>Good occasion to re-think a bit the DQM GUI applications and give a
  thought about what could be done to cope with less performant
  operating hardware</font>

--- .segue .dark .nobackground

## Few ideas 

--- &singleimage w1:100 image:images/OfflineAgentsChainLocal.png

## Possible scaling

### How to scale 

1. if single hardware is not enough to cope, spread load on multiple
servers (<font class='red'>divide et impera</font>)

1. even better if you spread the <font class='red bold'>most intensive
operations (read indexing)</font>

1. DQM GUI is a perfect example, since `indexing` is a simple serial queue

1. We have been file-based since RunI.

--- &singleimage w1:50 image:images/DQM_GUI_servers.png

## Current Architecture

--- &twoimages w1:45 w2:50 imageleft:images/DQM_GUI_servers_distributed.png imageright:images/OfflineAgentsChainDistributed.png

## Possible Distributed Architecture

--- .segue .dark .nobackground

## Challenges

---

## Challenges

### Main challenges
1. Internal coherence of DQM GUI (relatively easy)
1. External coherence versus exposed "dynamic" URL (RelMon example)
1. External coherence versus the already exposed API


### Internal coherence

* This could be done allowing the web server to concurrently handle
  multiple sources (<font class='yellow bold'>archive</font>) that
  point to separate folders with uniques <font class='yellow
  bold'>aliases</font>.

* The real challenge here is to be sure to <font class='red
  bold'>avoid duplicates</font>, i.e. be sure that <font class='red
  bold'>the same sample is always handled by the same
  backend</font>. Could be handled by a persistent catalogue on the
  webserver and an ad-hoc agent.

* <font class='yellow bold'>during migration I did exactly the same
  exercise</font>.

---

## Challenges

### Main challenges
1. Internal coherence of DQM GUI (relatively easy)
1. External coherence versus exposed "dynamic" URL (RelMon example)
1. External coherence versus the already exposed API

### External coherence versus exposed "dynamic" URL

* The most relevant example here is the URL of any image served by the
  DQM GUI.

* How to locate a single histogram that fast?

http://.../dqm/offline/<font class="blue2">plotfairy/</font><font class="red2">archive</font>/<font class='bold gray4'>196531</font>/<font class="green2">JetHT/Run2012B-PromptReco-v1/DQM</font>/<font class="yellow">Tracking/TrackParameters/GeneralProperties/NumberOfTracks_GenTk</font>...

* <font class="blue2">API specification</font>
* <font class="red2">Source specification(alias)</font>
* <font class="gray4 bold">Run Number</font>
* <font class="green2">Dataset specification</font>
* <font class="yellow2">Object Specification</font>

---

## Challenges

### Main challenges
1. Internal coherence of DQM GUI (relatively easy)
1. External coherence versus exposed "dynamic" URL (RelMon example)
1. External coherence versus the already exposed API

### External coherence versus exposed "dynamic" URL

* <font class='red bold'>BUT</font> we do not want to expose all
  different aliases through the API, since this will invalidate most
  of the apps developed on top of this (RelMon in primis).

* Moreover, users should know nothing about aliases and where the
  sample is located: all that matters is to specify a source on disk
  w.r.t to live

* Hide this complexity via a <font class='blue bold'>generic proxy
  API</font>

* <font class='bold yellow'>I already have a working prototype</font>.

---

## Challenges

### Main challenges
1. Internal coherence of DQM GUI (relatively easy)
1. External coherence versus exposed "dynamic" URL (RelMon example)
1. External coherence versus the already exposed API

### External coherence versus the already exposed API

http://.../dqm/offline/<font class="blue2">data/json</font>/<font class="red2">archive</font>/<font class='bold gray4'>196531</font>/<font class="green2">JetHT/Run2012B-PromptReco-v1/DQM</font>/<font class="yellow">Tracking/TrackParameters/GeneralProperties/NumberOfTracks_GenTk</font>...

* <font class="blue2">API specification</font>
* <font class="red2">Source specification(alias)</font>
* <font class="gray4 bold">Run Number</font>
* <font class="green2">Dataset specification</font>
* <font class="yellow2">Object Specification</font>

* I could apply the same solution used for the image URL API.


--- .segue .dark .nobackground

## Next Steps

---

## Next Steps

1. Being relatively close to data taking, it is always critical to
  radically redesign production software.

1. First address the imminent migration to VM and SLC6

1. Modify the core component software to handle multiple sources from
  the local disk

1. Setup a toy cluster of VM to play with.

1. Adapt the deployment procedure to install proper components on each
  VM.

1. Verify the modified core software on network mounted disks.

1. Embed data replication at configuration level?


--- &thankyou

## Thank you!

Questions & Answers

