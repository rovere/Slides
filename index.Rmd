---
title       : New Vertex Validation Package
subtitle    : Joint DQM/PdmV Meeting, 2014-09-02
author      : M. Rovere, G. Cerati
job         : CERN
framework   : io2012        # {io2012, html5slides, shower, dzslides, ...}
highlighter : prettify      # {highlight.js, prettify, highlight}
hitheme     : twitter-bootstrap # sunburst      #
widgets     : [mathjax]            # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone,draft}

---

## Introduction

### Purpose

These slides will explain

* the plots produced centrally by the PV Vertex validation package

* how they are organised, produced and filled

* how to run only this part of the full validation sequence in an
  effortless way, almost in standalone mode.

* Few, <font class="bold red">very preliminary</font> results obtained
  on a privatly produced TTbar sample, PU{25,40,70,140}@25ns.

### Current situation

* The package lives under ```Validation/RecoVertex```

* The code entered ```720pre2``` and is run be default using the
  standard ```VALIDATION``` step in ```cmsDriver.py```

* A porting of this code into ```SLHC``` release has been done but is
  not constantly kept up-to-date due to DQM Framework changes related
  to MT.

--- .segue .dark .nobackground

## Package Description

---

## Histograms Organization

* Histograms are divided into folders.

* The root folder for the most generic plots is configurable via the
parameter ```root_folder```, with a default value of <font class="red
bold">Validation/Vertices</font>.  The plots that are contained here
belong to two categories:

### Plots related to all Simulated Primary Vertices

Here we mean the real PV of the interaction plus all the PVs coming
from the in-time PU events. The simulated PV coming from the
out-of-time events are not included into these plots. The prefix for
these kind of plots is ```GenAllV_```.

### Plots related only to the Signal Primary Vertex

Here we only use the first vertex coming from bunch-crossing 0 and
event 0 in that bunch crossing. The prefix for these kind of plots is ```GenPV_```.

---

## Histograms Naming - Gen Level -

* Under the root folder, there are <font class="bold">as many folders
as ReconstructedParimaryVertex selectors have been defined in the
input configuration to the module via the parameter
(```cms.VInputTag```) ```vertexRecoCollections```</font>.

* Each folder will have exactly the same number
of histograms filled using the selected input collection.

* The histograms contained in each subfolder can be categorised
looking at the prefix in their name, as explained here and in the
following pages.

    * <font class="bold red">GenAllAssoc2Reco_</font>: these plots are
      used as <font class="bold blue">denominators for efficiency and
      duplicate plots</font>. We kind of duplicate plots here with
      respect to the ones contained in the main folder labelled with
      prefix ```GenAllV_``` in case we want to perform more detailed
      studies on a selection of generated vertices, not on all of
      them.

    * <font class="bold red">GenAllAssoc2RecoMatched_</font>: these
      plots are filled with information coming from all <font
      class="blue">simulated vertices</font> that are matched to a
      reconstructed vertex. These plots are used as <font class="bold
      blue">numerators for efficiency plots</font>. The matching is
      currently done based on both a cut on the absolute distance
      between the two vertices and the significance of
      z-separation. In future we plan to add also a matching based on
      the number of matched tracks belonging the the reconstructed
      vertex and the simulated one. All parameters are configurable.

    * <font class="bold red">GenAllAssoc2RecoMultiMatched_</font>:
      these plots are used as <font class="bold blue">numerators to
      compute the duplicate rate</font> for reconstructed
      vertices. They are filled with information coming from <font
      class="blue">simulated vertices</font> that have been associated
      to more than one reconstructed track.

---

## Histograms Naming - Reco Level -

* Histograms derived from <font class="blue">reconstructed
  vertices</font>.

    * <font class="bold red">RecoAllAssoc2Gen_</font>: these are used
      as <font class="bold blue">denominator to compute the fake,
      merge and duplicate rate</font>. These plots are filled with
      information coming from all <font class="blue">reconstructed
      vertices</font> belonging to the specific vertex collection used
      in input in the specific subfolder.

    * <font class="bold red">RecoAllAssoc2GenMatched_</font>: these
      plots are used as <font class="bold blue">numerators to compute
      the fake rate</font> (in fact it's 1 - this_entries that is the
      true value used as the numerator for the fake rate, which
      basically represents the reco vertices that have not been
      associated to any simulated vertex, hence they are fake) and are
      filled with information coming from the <font
      class="blue">reconstructed vertices</font> that have been
      associated to a simulated vertex.

    * <font class="bold red">RecoAllAssoc2GenMultiMatched_</font>:
      these plots are used as <font class="bold blue">numerators to
      compute the merge rate</font> and are filled with information
      coming from the <font class="blue">reconstructed vertices</font>
      that have been associated to more than one simulated vertex.

---

## Histograms Explanation

* The typical plots that are produced are:

    * <font class="bold red">Efficiency plots</font>: these plots are
      the ratio between the reconstructed vertices that have been
      associated to at least one generated vertex, divided by the
      corresponding plot filled with info coming from all the
      generated vertices plot.

    * <font class="bold red">Fake rate plots</font>: these plots
      represent the number of fake vertices, i.e. the number of
      reconstructed vertices that have not been associated to any
      simulated vertex.

    * <font class="bold red">Duplicate rate plots</font>: these plots
      represent the amount of vertices that have been reconstructed
      more than once. They are obtained using as numerator a histogram
      filled with information coming from simulated vertices that have
      been associated to more than one reconstructed vertex (hence the
      meaning of duplicate rate), and as denominator the whole set of
      reconstructed vertices.

    * <font class="bold red">Merge rate plots</font>: these plots
      represent the probability of having 2 different simulated
      vertices reconstructed as a single vertex. It is obtained by
      dividing a histogram filled with info coming from reconstructed
      vertices that have been associated to more than one simulated
      vertex, divided by the total number of reconstructed vertices.

---

## Monitored Variables

* Each of the previous plot is plotted as a function of a parameter. The ones currently used are:

    * Pt_2 of the vertex
    * Z position of the vertex
    * R position of the vertex
    * Number of vertices in the event
    * Number of tracks associated to the vertex
    * distance to the closest in z vertex

## Eff., Fake, Duplicate and MergeRate

* All efficiency, fake, duplicate and merge plots are produced in the
<font class="bold blue">harvesting step using the DQMGenericClient module</font>.

* Instead of pasting few command and python snippets here, I included a
README file under the test directory with rather detailed information
on how to run this validation module and its harvesting twin in
standalone-like mode. [Here](https://github.com/cms-sw/cmssw/blob/CMSSW_7_2_X/Validation/RecoVertex/test/README_VertexValidationSlimmed.txt) you can find the link.

* There is also a TWiki page
  [here](https://twiki.cern.ch/twiki/bin/view/CMS/TrackingVertexValidatorSlimmed)
  that contains all the information that I tried to include in this
  talk.


--- .segue .dark .nobackground

## Preliminary Results

--- &twoimages w1:45 w2:45 imageleft:images/selectedOfflinePrimaryVertices_RecoVtx_vs_GenVtx.png imageright:images/selectedOfflinePrimaryVertices_MatchedRecoVtx_vs_GenVtx.png

## Reconstructed vs Generated vertices

* The plot on the left shows the number of reconstructed (good)
  vertices as a function of the number of generated ones for <font style="color: #0f0;">25</font>, <font style="color: #ff0087;">40</font>,
  <font style="color: #0012ff">70</font>, <font style="color: #00c3ff">140</font> PU TTbar samples.

* The plot on the right shows the same, but requiring that the
  reconstructed vertex is also associated to a generated one.

* Both plots should be linear and the relative difference is
  proportional to the number of bad reco vertices that have been
  reconstructed.

--- &fourimages w1:33 w2:33 w3:0 w4:33 imageleft_most:images/selectedOfflinePrimaryVertices_effic_vs_NumVertices.png imageleft:images/selectedOfflinePrimaryVertices_effic_vs_NumTracks.png imageright_most:images/selectedOfflinePrimaryVertices_effic_vs_Pt2.png

## Efficiencies
 
* The leftmost plot shows the vertex-reconstruction efficiency as a
  function of the generated PU conditions

* The central plot shows the vertex-reconstruction efficiency as
  a function of the number of tracks associated to the simulated
  vertex.

* The rightmost plot shows the vertex-reconstruction efficiency as a
  function $\sum {p_t}^2$ of the tracks belonging to the generated
  vertex.

* The overall efficiency is around 70% (<font class="bold red"> with a
  steady decrease as PU increases</font>), while it is considerably
  higher for "bigger" and "harder" vertices.

--- &twoimages w1:45 w2:45 imageleft:images/selectedOfflinePrimaryVertices_fakerate_vs_PU.png  imageright:images/selectedOfflinePrimaryVertices_merged_vs_ClosestVertexInZ.png

## Fake and Merge Rates

* The plot on the left shows the fake rate as a function of the PU of
  the events

* The plot on the right shows the merge rate as a function of the
  closest distance between the simulated vertices associated to the
  reconstructed one.

* The overall (integrated) fake rate shows a steep growth as a
  function of the true PU, yet keeping below 10% up to PU 70.  For
  vertex distances above 1 mm the merge rate is practically
  negligible.

--- &singleimage w1:45 image:images/selectedOfflinePrimaryVertices_TruePVLocationIndexCumulative.png

## Signal Identification

* The plot shows the position (in the recovertex collection) at which
  the true signal vertex has been reconstructed. Entries at -1 refer
  to the case in which the signal vertex has not been reconstructed,
  while all entries above 1 have been collapsed at 1.

* The ratio between the entries in bin 0 and the sum of the entries in
  bin at -1 and 1, should give an idea of the misidentification rate.

* As we can see, for PU 25, 40 and 70 the misidentification rate is
  almost negligible, while it becomes an issue at PU 140.

---

## Small suggestion

* We usually had to monitor quantities over many order of
  magnitudes. Instead of booking a huge number of bins, we decided to
  create an ad-hoc, custom, logaritmic scale.

<pre class="prettyprint" data-lang="c++">
  double log_pt2_bins_double[<b>16</b>] = {
    0.0, 0.1, 0.5, 
    1.0, 2.0, 5.0,
    10.0, 20.0, 50.0,
    100.0, 200.0, 500.0, 
    1000.0, 2000.0, 5000.0,10000.0
   };
   ...
   ...
   mes_["root_folder"]["GenPV_Pt2"] =
       i.book1D("GenPV_Pt2", "GeneratedPV_Sum-pt2", <b>15</b>, &log_pt2_bins[0]);
</pre>


---

## Conclusions

* The Vertex Validation package has been revived and included into
  72X as of pre2

* Most of the plots are already there, but few others will soon come
  (pulls, residuals, others .. ?)

* Preliminary studies on a private samples in 72pre4
  {25,40,70,140}PU@25ns show that the vertex reconstruction is
  behaving as expected up to 70, while some tuning is needed at higher PU.

* More refined studies, tailored to the Upgrade and to higher PU
  scenarios, have been recently shown by Kevin
  [link](https://indico.cern.ch/event/334164/contribution/10/material/slides/0.pdf). Maybe
  in this case some further tuning of "good vertex selection" will be
  needed.

--- &thankyou

## Thank you!

Questions & Answers

--- .segue .dark .nobackground

## Backup




